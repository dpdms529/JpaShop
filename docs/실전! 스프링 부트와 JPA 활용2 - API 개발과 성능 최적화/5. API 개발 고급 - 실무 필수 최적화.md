# 5. API 개발 고급 - 실무 필수 최적화

## OSIV와 성능 최적화
- Open Session in View : 하이버네이트
- Open EntityManager In View : JPA
- 관례상 OSIV라함

### OSIV ON
- `spring.jpa.open-in-view : true` -> 기본값
- 애플리케이션 시작 시점에 warn 로그 남김
- 최초 데이터베이스 커넥션 시작 시점부터 API 응답이 끝날 때까지 영속성 컨텍스트와 데이터베이스 커넥션을 유지
- OSIV 때문에 View Template이나 API 컨트롤러에서 지연 로딩이 가능
- 지연 로딩은 영속성 컨텍스트가 살아있어야 가능하고, 영속성 컨텍스트는 기본적으로 데이터베이스 커넥션을 유지
- 너무 오랜시간동안 데이터베이스 커넥션 리소스를 사용하기 때문에 실시간 트래픽이 중요한 애플리케이션에서는 커넥션이 모자랄 수 있음 -> 장애로 이어짐

### OSIV OFF
- `spring.jpa.open-in-view : false` -> OSIV 종료
- 트랜잭션을 종료할 때 영속성 컨텍스트를 닫고, 데이터베이스 커넥션도 반환 -> 커넥션 리소스를 낭비 X
- 지연로딩을 트랜잭션 안에서 처리해야 함
- view template에서 지연로딩이 동작하지 않음

### 커멘드와 쿼리 분리
<https://github.com/dpdms529/JpaShop/commit/ac77a0785ccc8e41d2389e2a6b6d25e6e17b0e20>
- 비즈니스 로직은 특정 엔티티를 몇 개 등록하거나 수정하는 것이므로 성능이 크게 문제가 되지 않음
- 복잡한 화면을 출력하기 위한 쿼리는 화면에 맞춰 성능을 최적화하는 것이 중요
- 화면이나 API를 위한 서비스는 핵심 비즈니스에는 큰 영향을 주지 않기 때문에 이 둘의 관심사를 분리하는 것이 유지보수관점에서 좋음

### OSIV ON vs OFF
- OSIV를 키는 것이 좋긴 하지만 성능상 좋지 않음
- 고객 서비스의 실시간 API는 커넥션이 많이 필요하므로 OSIV를 끄고
- ADMIN처럼 커넥션을 많이 사용하지 않는 곳에서는 OSIV를 켜는 것이 좋음